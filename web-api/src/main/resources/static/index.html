<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Disk</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap">
  <style>
    :root {
      --bg: #0c111d;
      --panel: #111827;
      --panel-2: #0f1626;
      --accent: #60a5fa;
      --accent-2: #7dd3fc;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --border: #1f2937;
      --success: #34d399;
      --danger: #f87171;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(96,165,250,0.12), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(125,211,252,0.16), transparent 25%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #0e1627 0%, #0b1020 100%);
      border-right: 1px solid var(--border);
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .brand {
      font-weight: 600;
      letter-spacing: 0.5px;
      padding: 10px 12px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(96,165,250,0.15), rgba(125,211,252,0.12));
      border: 1px solid var(--border);
      color: #dbeafe;
    }
    .menu { list-style: none; padding: 0; margin: 10px 0 0; display: flex; flex-direction: column; gap: 6px; }
    .menu li button {
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.15s ease;
    }
    .menu li button.active { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(96,165,250,0.3); }
    .menu li button:hover { background: var(--panel-2); }
    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(96,165,250,0.15);
      color: var(--accent-2);
      border: 1px solid var(--border);
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px 24px;
      gap: 16px;
    }
    .panel {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }
    .top-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .breadcrumbs {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 14px;
    }
    .crumb {
      padding: 6px 10px;
      border-radius: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      cursor: pointer;
    }
    .crumb:hover { border-color: var(--accent); color: var(--accent-2); }
    .badge {
      padding: 6px 10px;
      border-radius: 8px;
      background: rgba(52,211,153,0.12);
      border: 1px solid rgba(52,211,153,0.2);
      color: #a7f3d0;
      font-size: 13px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
    }
    th { text-align: left; color: var(--muted); font-weight: 500; }
    tr { transition: background 0.12s ease; }
    tr:hover { background: rgba(96,165,250,0.05); }
    .muted { color: var(--muted); }
    .dir { color: var(--accent-2); font-weight: 600; cursor: pointer; }
    .error {
      background: rgba(248,113,113,0.12);
      border: 1px solid rgba(248,113,113,0.3);
      color: #fecdd3;
      padding: 10px 12px;
      border-radius: 10px;
      margin-top: 8px;
    }
    .empty {
      padding: 16px 0;
      color: var(--muted);
      font-size: 14px;
      text-align: center;
    }
    @media (max-width: 900px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; }
      .menu { flex-direction: row; flex-wrap: wrap; }
      .menu li { flex: 1 0 30%; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">Cloud Disk</div>
    <ul class="menu">
      <li><button data-tab="files" class="active">我的文件 <span class="pill">Browse</span></button></li>
      <li><button data-tab="shares">我的分享 <span class="pill">Links</span></button></li>
      <li><button data-tab="trash">回收站 <span class="pill">Soon</span></button></li>
    </ul>
  </aside>
  <main class="main">
    <section id="files" class="panel">
      <div class="top-bar">
        <div class="breadcrumbs" id="breadcrumbs"></div>
        <span class="badge" id="sourceBadge">加载存储源...</span>
      </div>
      <div id="fileError" class="error" style="display:none;"></div>
      <table>
        <thead>
          <tr><th>名称</th><th>类型</th><th>大小</th><th>更新时间</th></tr>
        </thead>
        <tbody id="fileTable"></tbody>
      </table>
      <div id="fileEmpty" class="empty" style="display:none;">此目录暂无文件</div>
    </section>

    <section id="shares" class="panel" style="display:none;">
      <div class="top-bar">
        <h3 style="margin:0;">我的分享</h3>
        <span class="badge">短链列表</span>
      </div>
      <div id="shareError" class="error" style="display:none;"></div>
      <table>
        <thead>
          <tr><th>Token</th><th>文件</th><th>过期时间</th><th>创建时间</th></tr>
        </thead>
        <tbody id="shareTable"></tbody>
      </table>
      <div id="shareEmpty" class="empty" style="display:none;">暂无分享</div>
    </section>

    <section id="trash" class="panel" style="display:none;">
      <div class="top-bar">
        <h3 style="margin:0;">回收站</h3>
        <span class="badge">即将上线</span>
      </div>
      <p class="muted">回收站功能暂未实现，后续将支持文件软删除与恢复。</p>
    </section>
  </main>

  <script>
    const state = {
      tab: 'files',
      sourceId: null,
      sourceName: '',
      path: ''
    };

    document.querySelectorAll('.menu button').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    function switchTab(tab) {
      state.tab = tab;
      document.querySelectorAll('.menu button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
      document.querySelectorAll('main .panel').forEach(panel => panel.style.display = panel.id === tab ? 'block' : 'none');
      if (tab === 'files') loadFiles(state.path);
      if (tab === 'shares') loadShares();
    }

    async function loadSources() {
      try {
        const res = await fetch('/api/storage-sources');
        if (!res.ok) throw new Error('无法获取存储源');
        const sources = await res.json();
        if (!sources.length) throw new Error('没有可用的存储源');
        state.sourceId = sources[0].id;
        state.sourceName = sources[0].name || ('源 #' + sources[0].id);
        document.getElementById('sourceBadge').textContent = state.sourceName;
        await loadFiles('');
      } catch (e) {
        document.getElementById('fileError').style.display = 'block';
        document.getElementById('fileError').textContent = e.message;
      }
    }

    function renderBreadcrumbs() {
      const holder = document.getElementById('breadcrumbs');
      holder.innerHTML = '';
      const root = document.createElement('span');
      root.className = 'crumb';
      root.textContent = '根目录';
      root.onclick = () => { state.path = ''; loadFiles(''); };
      holder.appendChild(root);
      if (!state.path) return;
      let acc = '';
      state.path.split('/').forEach((part, idx, arr) => {
        acc = acc ? acc + '/' + part : part;
        const span = document.createElement('span');
        span.className = 'crumb';
        span.textContent = part;
        if (idx < arr.length - 1) {
          span.onclick = () => { state.path = acc; loadFiles(acc); };
        } else {
          span.style.cursor = 'default';
          span.style.borderColor = 'var(--accent)';
        }
        holder.appendChild(span);
      });
    }

    function humanSize(bytes) {
      if (bytes == null || isNaN(bytes)) return '-';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let n = bytes, i = 0;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return n.toFixed(n >= 10 || i === 0 ? 0 : 1) + ' ' + units[i];
    }

    function humanTime(str) {
      if (!str) return '-';
      return new Date(str).toLocaleString();
    }

    async function loadFiles(path) {
      const errBox = document.getElementById('fileError');
      errBox.style.display = 'none';
      try {
        const res = await fetch(`/api/files/browse?sourceId=${state.sourceId}&path=${encodeURIComponent(path || '')}`);
        if (!res.ok) throw new Error('加载文件列表失败');
        const data = await res.json();
        state.path = path || '';
        renderBreadcrumbs();
        const tbody = document.getElementById('fileTable');
        tbody.innerHTML = '';
        if (!data.length) {
          document.getElementById('fileEmpty').style.display = 'block';
        } else {
          document.getElementById('fileEmpty').style.display = 'none';
        }
        data.forEach(item => {
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td');
          nameTd.textContent = item.filename;
          if (item.directory) {
            nameTd.className = 'dir';
            nameTd.title = '双击进入';
            nameTd.ondblclick = () => enterDirectory(item.filename);
          }
          tr.appendChild(nameTd);
          const typeTd = document.createElement('td');
          typeTd.textContent = item.directory ? '目录' : (item.contentType || '文件');
          tr.appendChild(typeTd);
          const sizeTd = document.createElement('td');
          sizeTd.textContent = item.directory ? '-' : humanSize(item.size);
          tr.appendChild(sizeTd);
          const timeTd = document.createElement('td');
          timeTd.textContent = humanTime(item.createdAt);
          tr.appendChild(timeTd);
          tbody.appendChild(tr);
        });
      } catch (e) {
        errBox.textContent = e.message;
        errBox.style.display = 'block';
      }
    }

    function enterDirectory(name) {
      const next = state.path ? `${state.path}/${name}` : name;
      loadFiles(next);
    }

    async function loadShares() {
      const errBox = document.getElementById('shareError');
      errBox.style.display = 'none';
      try {
        const res = await fetch('/api/files/short-links');
        if (!res.ok) throw new Error('加载分享列表失败');
        const data = await res.json();
        const tbody = document.getElementById('shareTable');
        tbody.innerHTML = '';
        if (!data.length) {
          document.getElementById('shareEmpty').style.display = 'block';
        } else {
          document.getElementById('shareEmpty').style.display = 'none';
        }
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><code>${item.token}</code></td>
            <td>${item.fileItem ? item.fileItem.filename : '-'}</td>
            <td>${item.expiresAt ? humanTime(item.expiresAt) : '永久'}</td>
            <td>${humanTime(item.createdAt)}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        errBox.textContent = e.message;
        errBox.style.display = 'block';
      }
    }

    loadSources();
  </script>
</body>
</html>
