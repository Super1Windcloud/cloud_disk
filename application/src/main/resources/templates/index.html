<!doctype html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Disk</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body th:data-google-enabled="${googleEnabled}">
<aside class="sidebar">
    <div class="brand">Cloud Disk</div>
    <ul class="menu" style="gap: 20px;">
        <li>
            <button data-tab="files" class="active">我的文件 <span class="pill">Browse</span></button>
        </li>
        <li>
            <button data-tab="shares">我的分享 <span class="pill">Links</span></button>
        </li>
        <li>
            <button data-tab="trash">回收站 <span class="pill">Soon</span></button>
        </li>
    </ul>
</aside>
<main class="main">
    <div class="top-bar user-bar">
        <div class="badge" id="sourceBadge">加载存储源...</div>
        <div class="spacer"></div>
        <div id="userBadge" class="user-badge"></div>
    </div>
    <section id="files" class="panel">
        <div class="top-bar">
            <div class="breadcrumbs" id="breadcrumbs"></div>
            <select id="sourceSelect" class="select"></select>
            <div class="controls">
                <button class="btn primary" id="uploadFileBtn" type="button">上传文件</button>
                <input id="fileInput" type="file" hidden>
                <button class="btn ghost" id="uploadFolderBtn" type="button">上传文件夹</button>
                <input id="folderInput" type="file" webkitdirectory multiple hidden>
                <button class="btn ghost" id="newFolderBtn" type="button">新建文件夹</button>
            </div>
        </div>
        <div id="fileError" class="error" style="display:none;"></div>
        <table>
            <thead>
            <tr>
                <th>名称</th>
                <th>类型</th>
                <th>大小</th>
                <th>创建时间</th>
            </tr>
            </thead>
            <tbody id="fileTable"></tbody>
        </table>
        <div id="fileEmpty" class="empty" style="display:none;">此目录暂无文件</div>
    </section>

    <section id="shares" class="panel" style="display:none;">
        <div class="top-bar">
            <h3 style="margin:0;">我的分享</h3>
            <span class="badge">短链列表</span>
        </div>
        <div id="shareError" class="error" style="display:none;"></div>
        <table>
            <thead>
            <tr>
                <th>Token</th>
                <th>文件</th>
                <th>过期时间</th>
                <th>创建时间</th>
            </tr>
            </thead>
            <tbody id="shareTable"></tbody>
        </table>
        <div id="shareEmpty" class="empty" style="display:none;">暂无分享</div>
    </section>

    <section id="trash" class="panel" style="display:none;">
        <div class="top-bar">
            <h3 style="margin:0;">回收站</h3>
            <span class="badge">即将上线</span>
        </div>
        <p class="muted">回收站功能暂未实现，后续将支持文件软删除与恢复。</p>
    </section>
</main>

<script>
    const state = {tab: 'files', sourceId: null, sourceName: '', path: ''};
    const googleEnabled = document.body.dataset.googleEnabled === 'true';
    const fileInput = document.getElementById('fileInput');
    const folderInput = document.getElementById('folderInput');

    document.querySelectorAll('.menu button').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    document.getElementById('sourceSelect').addEventListener('change', (e) => {
        state.sourceId = Number(e.target.value);
        state.sourceName = e.target.options[e.target.selectedIndex].textContent;
        document.getElementById('sourceBadge').textContent = state.sourceName;
        loadFiles(state.path);
    });

    document.getElementById('uploadFileBtn').addEventListener('click', () => fileInput.click());
    document.getElementById('uploadFolderBtn').addEventListener('click', () => folderInput.click());

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
            await uploadSingle(file, state.path);
            await loadFiles(state.path);
        } catch (err) {
            showError('fileError', err.message);
        } finally {
            e.target.value = '';
        }
    });

    folderInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;
        try {
            for (const file of files) {
                const rel = file.webkitRelativePath || file.name;
                const dir = rel.includes('/') ? rel.substring(0, rel.lastIndexOf('/')) : '';
                const targetDir = state.path ? (dir ? `${state.path}/${dir}` : state.path) : dir;
                await uploadSingle(file, targetDir);
            }
            await loadFiles(state.path);
        } catch (err) {
            showError('fileError', err.message);
        } finally {
            e.target.value = '';
        }
    });

    document.getElementById('newFolderBtn').addEventListener('click', async () => {
        const name = prompt('新建文件夹名称');
        if (!name) return;
        const target = state.path ? `${state.path}/${name}` : name;
        try {
            const res =
                await fetch(
                    `/api/files/directories?sourceId=${state.sourceId}&path=${encodeURIComponent(target)}`,
                    {method: 'POST', credentials: 'include'});
            if (!res.ok) throw new Error('创建失败');
            await loadFiles(state.path);
        } catch (err) {
            showError('fileError', err.message);
        }
    });

    function switchTab(tab) {
        state.tab = tab;
        document.querySelectorAll('.menu button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
        document.querySelectorAll('main .panel').forEach(panel => panel.style.display = panel.id === tab ? 'block' : 'none');
        if (tab === 'files') loadFiles(state.path);
        if (tab === 'shares') loadShares();
    }

    async function loadSources() {
        try {
            const res = await fetch('/api/storage-sources');
            if (!res.ok) throw new Error('无法获取存储源');
            const sources = await res.json();
            if (!sources.length) throw new Error('没有可用的存储源');
            const select = document.getElementById('sourceSelect');
            select.innerHTML = '';
            sources.forEach((s) => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name || `源 #${s.id}`;
                select.appendChild(opt);
            });
            const preferred =
                sources.find((s) => (s.name || '').toLowerCase() === 'minio-default')
                || sources[0];
            select.value = preferred.id;
            state.sourceId = Number(preferred.id);
            state.sourceName = preferred.name || `源 #${preferred.id}`;
            document.getElementById('sourceBadge').textContent = state.sourceName;
            await loadFiles('');
        } catch (e) {
            showError('fileError', e.message);
        }
    }

    function showError(id, msg) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.style.display = 'block';
    }

    function clearError(id) {
        const el = document.getElementById(id);
        el.style.display = 'none';
    }

    function renderBreadcrumbs() {
        const holder = document.getElementById('breadcrumbs');
        holder.innerHTML = '';
        const label = document.createElement('span');
        label.className = 'crumb-label';
        label.textContent = '当前位置';
        holder.appendChild(label);

        const root = document.createElement('span');
        root.className = `crumb${state.path ? '' : ' active'}`;
        root.textContent = '根目录';
        root.onclick = () => navigateToPath('');
        root.setAttribute('aria-current', state.path ? 'false' : 'page');
        holder.appendChild(root);

        if (!state.path) return;
        let acc = '';
        state.path.split('/').filter(Boolean).forEach((part, idx, arr) => {
            const separator = document.createElement('span');
            separator.className = 'crumb-sep';
            separator.textContent = '›';
            holder.appendChild(separator);

            acc = acc ? acc + '/' + part : part;
            const span = document.createElement('span');
            span.className = `crumb${idx === arr.length - 1 ? ' active' : ''}`;
            span.textContent = part;
            span.setAttribute('aria-current', idx === arr.length - 1 ? 'page' : 'false');
            if (idx < arr.length - 1) {
                span.onclick = () => navigateToPath(acc);
            }
            holder.appendChild(span);
        });
    }

    function humanSize(bytes) {
        if (bytes == null || isNaN(bytes)) return '-';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let n = bytes, i = 0;
        while (n >= 1024 && i < units.length - 1) {
            n /= 1024;
            i++;
        }
        return n.toFixed(n >= 10 || i === 0 ? 0 : 1) + ' ' + units[i];
    }

    function humanTime(str) {
        if (!str) return '-';
        return new Date(str).toLocaleString();
    }

    function iconFor(item) {
        const name = (item.filename || '').toLowerCase();
        const type = (item.contentType || '').toLowerCase();
        const ext = name.includes('.') ? name.substring(name.lastIndexOf('.') + 1) : '';
        if (item.directory) return {cls: 'folder', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18V6a1 1 0 0 1 1-1h5l2 2h9a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1Z"/></svg>'};
        const isImage = type.startsWith('image/') || ['png','jpg','jpeg','gif','bmp','svg','webp','heic','heif'].includes(ext);
        if (isImage) return {cls: 'image', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m3 16 4.5-4.5a2 2 0 0 1 2.8 0L17 18"/></svg>'};
        const isVideo = type.startsWith('video/') || ['mp4','mov','avi','mkv','webm'].includes(ext);
        if (isVideo) return {cls: 'video', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="m10 9 5 3-5 3V9Z"/></svg>'};
        const isAudio = type.startsWith('audio/') || ['mp3','wav','flac','aac','ogg','m4a'].includes(ext);
        if (isAudio) return {cls: 'audio', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V6l9-2v12"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="16" r="2"/></svg>'};
        const isArchive = ['zip','rar','7z','tar','gz','tgz','bz2'].includes(ext);
        if (isArchive) return {cls: 'archive', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="3" width="12" height="18" rx="2"/><path d="M12 3v18M9 7h2M9 11h2M9 15h2"/></svg>'};
        const isDoc = ['pdf','doc','docx','txt','md','rtf'].includes(ext);
        if (isDoc) return {cls: 'doc', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"/><path d="M14 3v6h6"/></svg>'};
        const isCode = ['js','ts','tsx','jsx','json','java','kt','go','py','rb','php','html','css','sql','xml','yml','yaml'].includes(ext);
        if (isCode) return {cls: 'code', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="m8 9-4 3 4 3M16 9l4 3-4 3M13 7l-2 10"/></svg>'};
        return {cls: '', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z"/><path d="M14 3v5h5"/></svg>'};
    }

    async function loadFiles(path) {
        if (!state.sourceId) return;
        clearError('fileError');
        try {
            const res = await fetch(
                `/api/files/browse?sourceId=${state.sourceId}&path=${encodeURIComponent(path || '')}`,
                {credentials: 'include'});
            if (!res.ok) throw new Error('加载文件列表失败');
            const data = await res.json();
            state.path = path || '';
            updateUrl();
            renderBreadcrumbs();
            const tbody = document.getElementById('fileTable');
            tbody.innerHTML = '';
            document.getElementById('fileEmpty').style.display = data.length ? 'none' : 'block';
            data.forEach(item => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                const nameWrap = document.createElement('div');
                nameWrap.className = 'name-cell';
                const iconMeta = iconFor(item);
                const icon = document.createElement('span');
                icon.className = `file-icon ${iconMeta.cls}`.trim();
                icon.innerHTML = iconMeta.svg;
                const nameLabel = document.createElement('span');
                nameLabel.textContent = item.filename;
                if (item.directory) {
                    nameLabel.className = 'dir';
                    nameWrap.title = '双击进入';
                    nameWrap.ondblclick = () => enterDirectory(item.filename);
                }
                nameWrap.appendChild(icon);
                nameWrap.appendChild(nameLabel);
                nameTd.appendChild(nameWrap);
                tr.appendChild(nameTd);
                const typeTd = document.createElement('td');
                typeTd.textContent = item.directory ? '目录' : (item.contentType || '文件');
                tr.appendChild(typeTd);
                const sizeTd = document.createElement('td');
                sizeTd.textContent = item.directory ? '-' : humanSize(item.size);
                tr.appendChild(sizeTd);
                const timeTd = document.createElement('td');
                timeTd.textContent = humanTime(item.createdAt);
                tr.appendChild(timeTd);
                tbody.appendChild(tr);
            });
        } catch (e) {
            showError('fileError', e.message);
        }
    }

    function navigateToPath(path) {
        loadFiles(path);
    }

    function enterDirectory(name) {
        const next = state.path ? `${state.path}/${name}` : name;
        navigateToPath(next);
    }

    async function loadShares() {
        clearError('shareError');
        try {
            const res = await fetch('/api/files/short-links', {credentials: 'include'});
            if (!res.ok) throw new Error('加载分享列表失败');
            const data = await res.json();
            const tbody = document.getElementById('shareTable');
            tbody.innerHTML = '';
            document.getElementById('shareEmpty').style.display = data.length ? 'none' : 'block';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><code>${item.token}</code></td>
                    <td>${item.fileItem ? item.fileItem.filename : '-'}</td>
                    <td>${item.expiresAt ? humanTime(item.expiresAt) : '永久'}</td>
                    <td>${humanTime(item.createdAt)}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            showError('shareError', e.message);
        }
    }

    function updateUrl() {
        const params = new URLSearchParams(window.location.search);
        if (state.path) {
            params.set('path', state.path);
        } else {
            params.delete('path');
        }
        if (state.sourceId) {
            params.set('sourceId', state.sourceId);
        }
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.replaceState({path: state.path, sourceId: state.sourceId}, '', newUrl);
    }

    window.addEventListener('popstate', (e) => {
        const path = (e.state && e.state.path) || new URLSearchParams(window.location.search).get('path') || '';
        const sourceId = (e.state && e.state.sourceId) || new URLSearchParams(window.location.search).get('sourceId');
        if (sourceId) {
            const select = document.getElementById('sourceSelect');
            const option = Array.from(select.options).find(o => Number(o.value) === Number(sourceId));
            if (option) {
                select.value = option.value;
                state.sourceId = Number(option.value);
                state.sourceName = option.textContent;
                document.getElementById('sourceBadge').textContent = state.sourceName;
            }
        }
        navigateToPath(path);
    });

    function applyInitialRoute() {
        const params = new URLSearchParams(window.location.search);
        const path = params.get('path') || '';
        const sourceId = params.get('sourceId');
        if (sourceId) {
            const select = document.getElementById('sourceSelect');
            const option = Array.from(select.options).find(o => Number(o.value) === Number(sourceId));
            if (option) {
                select.value = option.value;
                state.sourceId = Number(option.value);
                state.sourceName = option.textContent;
                document.getElementById('sourceBadge').textContent = state.sourceName;
            }
        }
        navigateToPath(path);
    }

    async function loadUser() {
        const badge = document.getElementById('userBadge');
        badge.innerHTML = '';
        try {
            const res = await fetch('/api/me', {credentials: 'include'});
            if (res.status === 401) {
                if (googleEnabled) {
                    const a = document.createElement('a');
                    a.className = 'btn primary';
                    a.href = '/oauth2/authorization/google';
                    a.textContent = '使用 Google 登录';
                    badge.appendChild(a);
                } else {
                    const span = document.createElement('span');
                    span.className = 'muted';
                    span.textContent = '未登录';
                    badge.appendChild(span);
                }
                return;
            }
            const user = await res.json();
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = (user.name || user.email || '?').slice(0, 1).toUpperCase();
            const info = document.createElement('div');
            info.className = 'user-info';
            info.innerHTML =
                `<div class="user-name">${user.name || user.email || ''}</div><div class="muted user-email">${user.email || ''}</div>`;
            const logout = document.createElement('a');
            logout.className = 'btn ghost';
            logout.href = '#';
            logout.textContent = '退出';
            logout.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await fetch('/logout', {method: 'POST', credentials: 'include'});
                } finally {
                    window.location.href = '/';
                }
            });
            badge.appendChild(avatar);
            badge.appendChild(info);
            badge.appendChild(logout);
        } catch (e) {
            const span = document.createElement('span');
            span.className = 'muted';
            span.textContent = '无法加载用户信息';
            badge.appendChild(span);
        }
    }

    async function uploadSingle(file, targetDir) {
        const form = new FormData();
        form.append('file', file);
        form.append('sourceId', state.sourceId);
        form.append('path', targetDir || '');
        const res = await fetch('/api/files/upload', {method: 'POST', body: form, credentials: 'include'});
        if (!res.ok) {
            throw new Error('上传失败');
        }
    }

    loadSources().then(applyInitialRoute);
    loadUser();
</script>
</body>
</html>
